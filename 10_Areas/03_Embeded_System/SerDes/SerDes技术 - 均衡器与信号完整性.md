---
tags:
  - "#domain/embedded"
  - "#type/knowledge"
  - "#level/advanced"
  - "#tech/serdes"
status: 完善中
complexity: 高级
notetype: 学习笔记
resource: SerDes技术文档
related:
  - "[[00_SerDes_MOC]]"
  - "[[SerDes架构 - 芯片架构与工作原理]]"
created: 2025-11-18 22:00:00
modified: 2025-11-18 22:00:00
---
# SerDes技术 - 均衡器与信号完整性

> [!abstract] 摘要
> 本笔记深入介绍SerDes中的均衡器技术,包括为什么需要均衡器、信号失真的原因、ISI码间干扰、常见均衡器类型及其工作原理。

## 🎯 Target
- [ ] 理解高速传输中的信号失真问题
- [ ] 掌握ISI(码间干扰)的概念和影响
- [ ] 了解常见均衡器类型及其作用
- [ ] 理解CTLE、FFE、DFE的工作原理和应用场景

## 📝 Core

### 为什么需要均衡器?

#### 信号传输中的问题

在高速串行数据传输中,信号会经历以下退化:

**1. 传输速率与信号退化的关系**

以相同传输通道为例,不同速率下的信号质量对比:

| 传输速率 | UI(单位间隔) | 信号质量    | 主要问题           |
|---------|-------------|-----------|-------------------|
| 2 Gbps  | 0.5 ns      | 基本完好   | 轻微衰减           |
| 8 Gbps  | 125 ps      | 明显衰减   | 边沿变缓、幅度下降 |
| 32 Gbps | 31.25 ps    | 严重失真   | 极低幅度、严重ISI  |

> [!note] UI (Unit Interval)
> UI是一个bit的时间长度:
> - 2 Gbps: UI = 1/2G = 0.5 ns
> - 32 Gbps: UI = 1/32G = 31.25 ps
>
> 速率越高,单位时间内要表示的比特越多,系统对**时间精度与波形完整性要求越高**。

**2. 信号失真现象**

原始发送信号 (Tx) vs 经过通道后的信号:
- ❌ **信号幅度下降** - 能量衰减
- ❌ **边沿变缓** - 高频成分损失
- ❌ **尾巴拖尾** - 前一个bit影响后续bit
- ❌ **眼图闭合** - 采样窗口缩小

**结论:**
- 速率越高,信号退化越严重
- 高频成分(快速上升/下降沿)在通道中被严重衰减
- 高频分量的损失使信号边缘变缓,导致信号展宽跨越不止一个UI

### 信号失真的根本原因

#### 1. 传输线的频率响应

**传输线表现为低通滤波器特性:**
- 低频信号衰减小
- 高频信号衰减大
- 衰减随频率增加而增大

**频率响应曲线:**
```
衰减(dB)
   0 |
     |        _____
  -5 |       /
 -10 |      /
 -15 |    /
 -20 |  /
 -25 |/_______________
     0  1  5  10  20  频率(GHz)

低频几乎无衰减,高频严重衰减
```

#### 2. 趋肤效应
- 高频电流趋向于在导体表面流动
- 有效导电截面积减小
- 电阻增大,损耗增加

#### 3. 介质损耗
- PCB基板、连接器等材料的损耗
- 频率越高,介质损耗越大

> [!important] 关键认识
> 影响信号的不是**衰减本身**,而是:
> - **信道的衰减随频率发生变化**
> - **高低频信号的衰减不一致**
> - **有衰减差异导致码间干扰(ISI)**
>
> 所以需要解决的并不是信号衰减,而是**高低频信号衰减不一致的问题**。

### ISI - 码间干扰

#### 定义
**ISI (Inter-Symbol Interference)** - 码间干扰

由于前一个bit的"尾巴"影响到后一个bit,造成码与码之间互相干扰。

#### 产生原因

**1. 带宽限制**
- 高频成分被抑制
- 信号上升沿/下降沿变缓
- 方波变"钝"

**2. 多路径效应**
- 信号反射
- 阻抗不匹配
- 连接器不连续性

**3. 时钟失真导致的展宽**
```
理想信号:    ┌─┐ ┌─┐ ┌─┐
            │ │ │ │ │ │
           ─┘ └─┘ └─┘ └─
            b0 b1 b2 b3

实际信号:    ┌──┐╱─╲┌──
            │  ╱   ╲│
           ─┘ ─     ─└──
            ← ISI →
```

**示例:**
发送: `...0 1 1 0...`

理想接收: 每个bit清晰独立

实际接收:
- 第一个'1'的尾巴影响第二个'1'
- 第二个'1'的尾巴影响'0'
- 采样点可能误判

#### ISI的影响
- 📉 **误码率(BER)上升**
- 📉 **眼图闭合**
- 📉 **抖动增加**
- 📉 **可靠传输距离缩短**

### 均衡器技术

均衡器的**核心目标**:补偿信道的频率选择性衰减,使得接收端能够正确恢复数据。

#### 1. CTLE - 连续时间线性均衡器

**Continuous-Time Linear Equalizer**

**类型:** 模拟均衡器

**位置:** 接收端(Rx)

**原理:**
- 通过减小低频分量来补偿高低频之间的衰减差
- 类似**高通滤波器**特性
- 放大高频成分,抵消通道对高频的衰减

**频率响应:**
```
增益(dB)
  +15|         ╱────
     |       ╱
   +5|     ╱
     |   ╱
    0|─╱─────────────
     0  1  5  10  20  频率(GHz)

与通道的低通特性相反,形成补偿
```

**实现:**
- 通常使用运放或者源极退化电路
- 可调节增益和带宽

**优点:**
- ✅ 结构简单
- ✅ 功耗低
- ✅ 延迟小

**缺点:**
- ❌ 会放大高频噪声
- ❌ 补偿能力有限
- ❌ 无法处理反射等非线性失真

**应用场景:**
- 中等损耗的通道
- 与DFE配合使用
- 作为第一级均衡

#### 2. FFE - 前馈均衡器

**Feed-Forward Equalizer**

**类型:** 数字均衡器

**位置:** 发送端(Tx)或接收端(Rx)

**原理:**
- 类似**FIR滤波器**
- 通过前向加权多个bit的数据,对当前bit进行调节
- 有多个tap(抽头),每个tap有可调权重

**结构:**
```
数据流:  D[n-1]  D[n]  D[n+1]
           |      |      |
          [C-1]  [C0]  [C+1]  ← tap系数
           |      |      |
           └──────Σ──────┘
                  ↓
              输出数据
```

**工作方式:**
```
输出 = C[-1]×D[n-1] + C[0]×D[n] + C[1]×D[n+1]
```

**典型tap配置:**
- 3-tap FFE: 1个主tap + 2个副tap
- 5-tap FFE: 1个主tap + 4个副tap

**Tx端FFE (Pre-emphasis):**
- 在发送端预先对信号进行加重
- 对高频成分进行预补偿
- 减轻接收端的均衡压力

**Rx端FFE:**
- 在接收端进行线性均衡
- 可以与DFE配合使用

**优点:**
- ✅ 可以精确控制频率响应
- ✅ 不放大噪声(Tx端FFE)
- ✅ 线性处理,实现相对简单

**缺点:**
- ❌ 可能放大噪声(Rx端FFE)
- ❌ 无法消除后cursor ISI
- ❌ 功耗较高(tap越多功耗越大)

**应用场景:**
- Tx端预加重
- 补偿通道的可预知失真
- 与DFE配合使用

#### 3. DFE - 判决反馈均衡器

**Decision Feedback Equalizer**

**类型:** 非线性数字均衡器

**位置:** 接收端(Rx)

**原理:**
- 通过**前面已经判决过的数据**反馈来消除ISI
- 只对已知的干扰做补偿
- 不会放大噪声(因为使用判决后的clean数据)

**结构:**
```
输入 → [判决器] → 输出
  ↑       |
  |     [反馈]
  |       ↓
  └─[减法器]←─[FIR滤波器]
```

**工作流程:**
1. 接收信号经过CTLE/FFE后送入判决器
2. 判决器输出clean的'0'或'1'
3. 通过FIR滤波器计算这些已判决bit对当前bit的ISI影响
4. 从输入信号中减去这个ISI
5. 得到更干净的信号送入判决器

**数学表示:**
```
y[n] = x[n] - Σ(Ck × D[n-k])
           k=1 to N

其中:
- x[n]: 输入信号
- D[n-k]: 已判决的历史数据
- Ck: DFE tap系数
- N: DFE tap数量
```

**优点:**
- ✅ 不会放大噪声(使用clean判决数据)
- ✅ 可以有效消除post-cursor ISI
- ✅ 效果优于纯FFE
- ✅ 适合严重ISI的场景

**缺点:**
- ❌ 实现复杂(需要高速反馈路径)
- ❌ 如果第一个bit判决错误,会导致错误传播
- ❌ 对时序要求高
- ❌ 功耗较高

**应用场景:**
- 长距离、高损耗通道
- 高速SerDes(>10Gbps)
- 与CTLE/FFE配合使用

### 均衡器组合策略

实际SerDes通常组合使用多种均衡器:

#### 典型配置1: CTLE + DFE (接收端)
```
信号输入 → [CTLE] → [DFE] → 判决输出
            ↑         ↑
         放大高频   消除ISI
```

**优势:**
- CTLE处理线性频率响应失真
- DFE处理非线性ISI
- 互补效果好

#### 典型配置2: Tx FFE + Rx CTLE + Rx DFE
```
Tx: 数据 → [FFE] → 发送
           预加重

Rx: 接收 → [CTLE] → [DFE] → 输出
          初步均衡  精细均衡
```

**优势:**
- Tx预加重减轻Rx负担
- 多级均衡,效果最优
- 适合超高速(>25Gbps)应用

#### 典型配置3: Tx FFE + Rx FFE + Rx DFE
```
适用于极高损耗通道
多级补偿,最大化眼图张开
```

### 均衡器参数调整

#### 自适应均衡
现代SerDes通常具有**自适应均衡**功能:
- 通过算法自动调整均衡器参数
- 常用算法: LMS(最小均方)、Zero-Forcing等
- 目标: 最大化眼图张开、最小化BER

#### 手动调整
某些SerDes允许手动配置:
- CTLE增益
- FFE tap系数
- DFE tap系数

**调整策略:**
1. 初始使用默认值
2. 观察眼图质量
3. 逐步调整参数
4. 测试BER性能
5. 确定最优配置

---
## 🤔 Q&A

### Q1: 为什么不能简单地放大整个信号来补偿衰减?
**A**: 简单放大会同时放大信号和噪声,无法改善信噪比(SNR)。关键问题是**频率相关的衰减**,需要有选择性地补偿不同频率成分。

### Q2: DFE为什么不会放大噪声?
**A**: 因为DFE使用的是**已判决的数据**(clean的0或1),而不是原始的noisy信号。判决过程本质上是一个"去噪"操作。

### Q3: 均衡器能补偿所有信号失真吗?
**A**: 不能。均衡器主要补偿:
- ✅ 频率相关的衰减
- ✅ 可预测的ISI
- ❌ 无法补偿随机噪声
- ❌ 无法补偿过度失真(完全闭合的眼图)

### Q4: 如何评估均衡效果?
**A**: 常用指标:
- **眼图张开度** - 垂直眼高和水平眼宽
- **BER (误码率)** - 通常要求<10⁻¹²
- **抖动(Jitter)** - RJ(随机抖动)和DJ(确定性抖动)
- **信噪比(SNR)** - 信号功率/噪声功率

## 🚀 Tasks
- [ ] 使用示波器观察有/无均衡器的眼图对比
- [ ] 计算不同tap配置的FFE频率响应
- [ ] 分析DFE的错误传播机制
- [ ] 研究自适应均衡算法(LMS)

## 📚 Reference
* High-Speed Digital Design - Signal Integrity
* SerDes Equalizer Design and Analysis
* PCIe PHY Equalization Techniques
* Xilinx GTX/GTH Transceiver User Guide

## 🕸️ Relation
* 这篇笔记是[[00_SerDes_MOC|SerDes知识体系]]的高级技术部分
* [[SerDes架构 - 芯片架构与工作原理]] - 均衡器在整体架构中的位置
* [[SerDes技术 - Tx发送器模块]] - FFE在Tx端的应用
* [[SerDes技术 - Rx接收器模块]] - CTLE和DFE在Rx端的应用
